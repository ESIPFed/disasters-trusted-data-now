<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Trusted Data Now – ESIP Disasters Cluster</title>
  <!-- GitHub Pages: https://esipfed.github.io/disasters-trusted-data-now/ -->
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --primary: #0066cc;
      --primary-light: #e6f2ff;
      --success: #22863a;
      --success-light: #dcffe4;
      --text: #24292e;
      --text-light: #586069;
      --border: #e1e4e8;
      --bg: #f6f8fa;
      --white: #ffffff;
      --shadow: 0 1px 3px rgba(0,0,0,0.1);
      --shadow-lg: 0 10px 40px rgba(0,0,0,0.1);
      --danger: #d73a49;
      --danger-light: #ffeef0;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif; color: var(--text); line-height: 1.6; background: var(--white); }
    .header { background: var(--white); border-bottom: 1px solid var(--border); padding: 2rem 0; }
    .container { max-width: 1200px; margin: 0 auto; padding: 0 1rem; }
    h1 { font-size: 2rem; font-weight: 700; margin-bottom: 0.25rem; }
    .subtitle { color: var(--text-light); font-size: 1.05rem; }

    .toolbar { background: var(--bg); border-bottom: 1px solid var(--border); padding: 1.5rem 0; position: sticky; top: 0; z-index: 100; }
    .toolbar-content { display: flex; gap: 1rem; flex-wrap: wrap; align-items: center; }
    .search-container { flex: 1; min-width: 280px; }
    .search-input { width: 100%; padding: .5rem 1rem; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem; transition: border-color .2s; }
    .search-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }

    .filters { display: flex; gap: .5rem; flex-wrap: wrap; }
    select { padding: .5rem 1rem; border: 1px solid var(--border); border-radius: 6px; background: var(--white); font-size: .9rem; cursor: pointer; transition: border-color .2s; }
    select:hover { border-color: var(--text-light); }
    select:focus { outline: none; border-color: var(--primary); }

    .btn { padding: .5rem 1rem; border: 1px solid var(--border); border-radius: 6px; background: var(--white); font-size: .9rem; cursor: pointer; transition: all .2s; text-decoration: none; display: inline-flex; align-items: center; gap: .5rem; }
    .btn:hover { background: var(--bg); }
    .btn-primary { background: var(--primary); color: var(--white); border-color: var(--primary); }
    .btn-primary:hover { background: #0052a3; }

    .view-toggle { display: flex; gap: .25rem; background: var(--bg); padding: .25rem; border-radius: 6px; }
    .view-toggle button { padding: .5rem 1rem; border: none; background: transparent; border-radius: 4px; cursor: pointer; }
    .view-toggle button.active { background: var(--white); box-shadow: var(--shadow); }

    .stats-bar { padding: 1.5rem 0; border-bottom: 1px solid var(--border); }
    .stats { display: flex; gap: 3rem; flex-wrap: wrap; margin-bottom: 1rem; }
    .stat { display: flex; flex-direction: column; }
    .stat-value { font-size: 1.5rem; font-weight: 600; color: var(--text); }
    .stat-label { font-size: .875rem; color: var(--text-light); }
    
    .type-stats { display: flex; gap: 2rem; flex-wrap: wrap; justify-content: flex-start; }
    .type-stat { display: flex; flex-direction: column; align-items: center; min-width: 80px; }
    .type-emoji { font-size: 1.5rem; margin-bottom: 0.25rem; }
    .type-count { font-size: 1.25rem; font-weight: 600; color: var(--text); }
    .type-label { font-size: .75rem; color: var(--text-light); text-align: center; }

    .main-content { padding: 2rem 0; }
    .resource-grid { display: grid; gap: 1rem; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); }
    .resource-card { background: var(--white); border: 1px solid var(--border); border-radius: 6px; padding: 1.5rem; transition: box-shadow .2s; }
    .resource-card:hover { box-shadow: var(--shadow-lg); }
    .resource-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem; }
    .resource-title { font-size: 1.25rem; font-weight: 600; color: var(--text); margin-bottom: .25rem; }
    .resource-org { color: var(--text-light); font-size: .9rem; }
    .resource-badges { display: flex; gap: .5rem; flex-wrap: wrap; }
    .badge { padding: .25rem .75rem; border-radius: 20px; font-size: .75rem; font-weight: 500; text-transform: uppercase; letter-spacing: .5px; }
    .badge-public { background: var(--success-light); color: var(--success); }
    .badge-restricted { background: var(--danger-light); color: var(--danger); }
    .badge-active { background: var(--primary-light); color: var(--primary); }
    .badge-inactive { background: var(--bg); color: var(--text-light); }
    .resource-description { color: var(--text); margin-bottom: 1rem; line-height: 1.5; }
    .resource-meta { display: flex; gap: 1.25rem; flex-wrap: wrap; padding-top: 1rem; border-top: 1px solid var(--border); font-size: .9rem; color: var(--text-light); }
    .resource-link { color: var(--primary); text-decoration: none; }
    .resource-link:hover { text-decoration: underline; }
    .type-tag { display: inline-block; padding: .125rem .5rem; background: var(--bg); border-radius: 4px; font-size: .875rem; color: var(--text); }

    .table-view { display: none; overflow-x: auto; border: 1px solid var(--border); border-radius: 6px; background: var(--white); }
    table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    th { background: var(--bg); padding: .75rem 1rem; text-align: left; font-weight: 600; font-size: .875rem; color: var(--text); border-bottom: 1px solid var(--border); }
    th:nth-child(1) { width: 30%; } /* Name - largest column */
    th:nth-child(2) { width: 20%; } /* Type(s) */
    th:nth-child(3) { width: 22.5%; } /* Status */
    th:nth-child(4) { width: 20%; } /* Organization */
    th:nth-child(5) { width: 10%; } /* Link */
    th:nth-child(6) { width: 7.5%; text-align: center; } /* Status */
    td { padding: .75rem 1rem; border-bottom: 1px solid var(--border); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    td:first-child { white-space: normal; }
    td:nth-child(2) { white-space: normal; }
    td:nth-child(4) { white-space: normal; }
    td:nth-child(5) { white-space: nowrap; } /* Link column */
    td:nth-child(6) { white-space: nowrap; text-align: center; } /* Status column */
    .status-working { color: var(--success); font-weight: bold; }
    .status-warning { color: #f59e0b; font-weight: bold; }

    .empty-state { text-align: center; padding: 4rem 2rem; color: var(--text-light); }
    .empty-state h3 { font-size: 1.25rem; margin-bottom: .5rem; color: var(--text); }
    
    .last-checked-info { 
      background: var(--bg); 
      border: 1px solid var(--border); 
      border-radius: 6px; 
      padding: 1rem; 
      margin-bottom: 1rem; 
      font-size: .9rem; 
      color: var(--text-light); 
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="container">
      <h1>Trusted Data Now</h1>
      <p class="subtitle">ESIP Disasters Cluster project: community-curated tools and datasets for disaster readiness and responses</p>
      <p style="font-size: 0.9rem; color: var(--text-light); margin-top: 0.5rem;">
        <a href="https://www.esipfed.org/" style="color: var(--primary); text-decoration: none;">ESIP Federation</a> Disasters Cluster | Project Lead: Jeil Oh (jeoh@utexas.edu)
      </p>
    </div>
  </header>

  <div class="toolbar">
    <div class="container">
      <div class="toolbar-content">
        <div class="search-container">
          <input type="text" class="search-input" id="searchInput" placeholder="Search resources..." aria-label="Search resources"/>
        </div>
        <div class="filters">
          <select id="typeFilter" aria-label="Filter by type">
            <option value="">All Types</option>
            <option value="flood">Flood</option>
            <option value="earthquake">Earthquake</option>
            <option value="wildfire">Wildfire</option>
            <option value="drought">Drought</option>
            <option value="hurricane">Hurricane</option>
            <option value="tornado">Tornado</option>
            <option value="extreme-weather">Extreme weather</option>
            <option value="other">Other</option>
          </select>
          <select id="statusFilter" aria-label="Filter by status">
            <option value="">All Status</option>
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
          </select>
        </div>

        <!-- Direct link to Google Form -->
        <a id="openFormBtn" class="btn btn-primary" href="#" target="_blank" rel="noopener">+ Submit via Google Form</a>

        <div class="view-toggle" role="tablist" aria-label="View toggle">
          <button id="cardViewBtn" onclick="setView('card')" role="tab" aria-selected="false">Cards</button>
          <button id="tableViewBtn" class="active" onclick="setView('table')" role="tab" aria-selected="true">Table</button>
        </div>
      </div>
    </div>
  </div>

  <div class="stats-bar">
    <div class="container">
      <div class="stats">
        <div class="stat">
          <span class="stat-value" id="totalCount">0</span>
          <span class="stat-label">Total Resources</span>
        </div>
        <div class="stat">
          <span class="stat-value" id="publicCount">0</span>
          <span class="stat-label">Public Access</span>
        </div>
        <div class="stat">
          <span class="stat-value" id="activeCount">0</span>
          <span class="stat-label">Active Now</span>
        </div>
        <div class="stat">
          <span class="stat-value" id="orgCount">0</span>
          <span class="stat-label">Organizations</span>
        </div>
      </div>
      <div class="type-stats" id="typeStats" style="display:none;">
        <div class="type-stat">
          <span class="type-emoji">🌊</span>
          <span class="type-count" id="floodCount">0</span>
          <span class="type-label">Flood</span>
        </div>
        <div class="type-stat">
          <span class="type-emoji">🌍</span>
          <span class="type-count" id="earthquakeCount">0</span>
          <span class="type-label">Earthquake</span>
        </div>
        <div class="type-stat">
          <span class="type-emoji">🔥</span>
          <span class="type-count" id="wildfireCount">0</span>
          <span class="type-label">Wildfire</span>
        </div>
        <div class="type-stat">
          <span class="type-emoji">☀️</span>
          <span class="type-count" id="droughtCount">0</span>
          <span class="type-label">Drought</span>
        </div>
        <div class="type-stat">
          <span class="type-emoji">🌀</span>
          <span class="type-count" id="hurricaneCount">0</span>
          <span class="type-label">Hurricane</span>
        </div>
        <div class="type-stat">
          <span class="type-emoji">🌪️</span>
          <span class="type-count" id="tornadoCount">0</span>
          <span class="type-label">Tornado</span>
        </div>
        <div class="type-stat">
          <span class="type-emoji">⛈️</span>
          <span class="type-count" id="extremeWeatherCount">0</span>
          <span class="type-label">Extreme Weather</span>
        </div>
        <div class="type-stat">
          <span class="type-emoji">📋</span>
          <span class="type-count" id="otherCount">0</span>
          <span class="type-label">Other</span>
        </div>
      </div>
    </div>
  </div>

  <main class="main-content">
    <div class="container">
      <div id="loadingState" class="empty-state">
        <h3>Loading resources…</h3>
        <p>Fetching the latest <code>data.json</code> from GitHub Pages</p>
      </div>

      <div id="lastCheckedInfo" class="last-checked-info" style="display:none;">
        <p><strong>Last accessibility check:</strong> <span id="lastCheckedTime">—</span></p>
      </div>

      <div id="cardView" class="resource-grid" style="display:none;"></div>

      <div id="tableView" class="table-view" style="display:block;">
        <table aria-label="Resources table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Type(s)</th>
              <th>Status</th>
              <th>Organization</th>
              <th>Link</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>

      <div id="emptyState" class="empty-state" style="display:none;">
        <h3>No resources found</h3>
        <p>Try adjusting your search or filters</p>
      </div>
    </div>
  </main>

  <script>
    // === Replace this with your form's Preview URL (must be /d/e/.../viewform) ===
    const GOOGLE_FORM_VIEW_URL = "https://docs.google.com/forms/d/e/1FAIpQLSca1QqteZBgFN0qoY3APbMVH0i-xtmDoUXjCLtgKoT4-9NMeg/viewform";

    // Hook the button to open your form
    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('openFormBtn');
      btn.href = GOOGLE_FORM_VIEW_URL;
    });

    // === Load data.json at runtime ===
    let resources = [];
    let filteredResources = [];
    let currentView = 'table';

    function getTypeLabelsForUI(types) {
      const map = {
        'flood': '🌊 Flood', 'earthquake': '🌍 Earthquake', 'wildfire': '🔥 Wildfire',
        'drought': '☀️ Drought', 'hurricane': '🌀 Hurricane', 'tornado': '🌪️ Tornado',
        'extreme-weather': '⛈️ Extreme weather', 'other': '📋 Other'
      };
      return types.map(t => map[t] || t.replace(/-/g,' ').replace(/\b\w/g,m=>m.toUpperCase()));
    }

    function asTypeArray(t) {
      if (Array.isArray(t)) return t;
      if (!t) return [];
      return [String(t)];
    }

    async function loadResources() {
      const loading = document.getElementById('loadingState');
      const cardView = document.getElementById('cardView');
      const tableView = document.getElementById('tableView');
      const emptyState = document.getElementById('emptyState');

      loading.style.display = 'block';
      cardView.style.display = 'none';
      tableView.style.display = 'none';
      emptyState.style.display = 'none';

      try {
        const res = await fetch('data.json?cb=' + Date.now(), { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        resources = Array.isArray(data) ? data : [];
        filteredResources = [...resources];
        renderResources();
        setView(currentView);
        loading.style.display = 'none';
        if (filteredResources.length === 0) emptyState.style.display = 'block';
      } catch (err) {
        console.error('Failed to load data.json', err);
        loading.innerHTML = `
          <h3>Could not load resources</h3>
          <p style="margin-top:.5rem;">Ensure <code>data.json</code> exists at the site root and GitHub Pages is enabled.</p>
        `;
      }
    }

    function renderResources() {
      const cardContainer = document.getElementById('cardView');
      const tableBody = document.getElementById('tableBody');
      const emptyState = document.getElementById('emptyState');

      if (!filteredResources.length) {
        cardContainer.innerHTML = '';
        tableBody.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }
      emptyState.style.display = 'none';

      cardContainer.innerHTML = filteredResources.map(resource => {
        const types = asTypeArray(resource.type);
        const labels = getTypeLabelsForUI(types);
        const pubBadge = resource.public ? '<span class="badge badge-public">Public</span>' : '<span class="badge badge-restricted">Restricted</span>';
        const actBadge = resource.active ? '<span class="badge badge-active">Active</span>' : '<span class="badge badge-inactive">Inactive</span>';
        const sub = resource.subscription === true ? ' • Subscription' : '';
        const ro = resource.researchOrOps ? ` • ${escapeHTML(resource.researchOrOps)}` : '';
        return `
          <div class="resource-card">
            <div class="resource-header">
              <div>
                <div class="resource-title">${escapeHTML(resource.name || 'Untitled')}</div>
                <div class="resource-org">${escapeHTML(resource.organization || 'Unknown')}</div>
              </div>
              <div class="resource-badges">${pubBadge}${actBadge}</div>
            </div>
            <p class="resource-description">${escapeHTML(resource.description || '')}</p>
            <div class="resource-meta">
              <div>${labels.map(l => `<span class="type-tag">${escapeHTML(l)}</span>`).join(' ')}</div>
              <div><a href="${escapeAttr(resource.url || '#')}" target="_blank" rel="noopener noreferrer" class="resource-link">View Resource →</a></div>
              ${resource.contact ? `<div>📧 ${escapeHTML(resource.contact)}</div>` : ''}
              ${resource.notes ? `<div>📝 ${escapeHTML(resource.notes)}</div>` : ''}
              ${(sub || ro) ? `<div>${sub}${ro}</div>` : ''}
            </div>
          </div>
        `;
      }).join('');

      tableBody.innerHTML = filteredResources.map(resource => {
        const types = asTypeArray(resource.type);
        const labels = getTypeLabelsForUI(types);
        const pubBadge = resource.public ? '<span class="badge badge-public">Public</span>' : '<span class="badge badge-restricted">Restricted</span>';
        const actBadge = resource.active ? '<span class="badge badge-active">Active</span>' : '<span class="badge badge-inactive">Inactive</span>';
        
        // Link status - simple emoji with colors
        let linkStatus = '—';
        if (resource.accessible !== undefined) {
          if (resource.accessible) {
            linkStatus = '<span class="status-working">✓</span>';
          } else {
            linkStatus = '<span class="status-warning">⚠️</span>';
          }
        }
        
        
        return `
          <tr>
            <td><strong>${escapeHTML(resource.name || 'Untitled')}</strong></td>
            <td>${labels.map(l => `<span class="type-tag">${escapeHTML(l)}</span>`).join(' ')}</td>
            <td>${pubBadge} ${actBadge}</td>
            <td>${escapeHTML(resource.organization || '—')}</td>
            <td><a href="${escapeAttr(resource.url || '#')}" target="_blank" rel="noopener noreferrer" class="resource-link">View →</a></td>
            <td>${linkStatus}</td>
          </tr>
        `;
      }).join('');

      updateStats();
      updateLastCheckedInfo();
    }

    function updateStats() {
      document.getElementById('totalCount').textContent = resources.length;
      document.getElementById('publicCount').textContent = resources.filter(r => r.public).length;
      document.getElementById('activeCount').textContent = resources.filter(r => r.active).length;
      const orgs = new Set(resources.map(r => (r.organization || '').trim()).filter(Boolean));
      document.getElementById('orgCount').textContent = orgs.size;
      
      // Update type statistics
      updateTypeStats();
    }

    function updateTypeStats() {
      const typeCounts = {
        'flood': 0,
        'earthquake': 0,
        'wildfire': 0,
        'drought': 0,
        'hurricane': 0,
        'tornado': 0,
        'extreme-weather': 0,
        'other': 0
      };
      
      // Count resources by type
      resources.forEach(resource => {
        const types = asTypeArray(resource.type);
        types.forEach(type => {
          if (typeCounts.hasOwnProperty(type)) {
            typeCounts[type]++;
          }
        });
      });
      
      // Update the display
      document.getElementById('floodCount').textContent = typeCounts['flood'];
      document.getElementById('earthquakeCount').textContent = typeCounts['earthquake'];
      document.getElementById('wildfireCount').textContent = typeCounts['wildfire'];
      document.getElementById('droughtCount').textContent = typeCounts['drought'];
      document.getElementById('hurricaneCount').textContent = typeCounts['hurricane'];
      document.getElementById('tornadoCount').textContent = typeCounts['tornado'];
      document.getElementById('extremeWeatherCount').textContent = typeCounts['extreme-weather'];
      document.getElementById('otherCount').textContent = typeCounts['other'];
      
      // Show the type stats section
      document.getElementById('typeStats').style.display = 'flex';
    }

    function updateLastCheckedInfo() {
      const lastCheckedInfo = document.getElementById('lastCheckedInfo');
      const lastCheckedTime = document.getElementById('lastCheckedTime');
      
      // Find the most recent lastChecked timestamp
      let mostRecentCheck = null;
      for (const resource of resources) {
        if (resource.lastChecked) {
          if (!mostRecentCheck || resource.lastChecked > mostRecentCheck) {
            mostRecentCheck = resource.lastChecked;
          }
        }
      }
      
      if (mostRecentCheck) {
        try {
          const checkDate = new Date(mostRecentCheck);
          const now = new Date();
          const diffHours = Math.floor((now - checkDate) / (1000 * 60 * 60));
          
          let timeText;
          if (diffHours < 1) {
            timeText = 'Just now';
          } else if (diffHours < 24) {
            timeText = `${diffHours} hours ago`;
          } else {
            const diffDays = Math.floor(diffHours / 24);
            timeText = `${diffDays} days ago`;
          }
          
          lastCheckedTime.textContent = timeText;
          lastCheckedInfo.style.display = 'block';
        } catch (e) {
          lastCheckedInfo.style.display = 'none';
        }
      } else {
        lastCheckedInfo.style.display = 'none';
      }
    }

    function filterResources() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const typeFilter = document.getElementById('typeFilter').value;
      const statusFilter = document.getElementById('statusFilter').value;

      filteredResources = resources.filter(resource => {
        const name = (resource.name || '').toLowerCase();
        const desc = (resource.description || '').toLowerCase();
        const org = (resource.organization || '').toLowerCase();

        const matchesSearch = !searchTerm || name.includes(searchTerm) || desc.includes(searchTerm) || org.includes(searchTerm);

        const types = asTypeArray(resource.type);
        const matchesType = !typeFilter || types.includes(typeFilter);

        let matchesStatus = true;
        if (statusFilter === 'active') matchesStatus = resource.active === true;
        else if (statusFilter === 'inactive') matchesStatus = resource.active === false;

        return matchesSearch && matchesType && matchesStatus;
      });

      renderResources();
      setView(currentView);
    }

    function setView(view) {
      currentView = view;
      const cardView = document.getElementById('cardView');
      const tableView = document.getElementById('tableView');
      const cardBtn = document.getElementById('cardViewBtn');
      const tableBtn = document.getElementById('tableViewBtn');

      if (view === 'card') {
        cardView.style.display = 'grid';
        tableView.style.display = 'none';
        cardBtn.classList.add('active'); cardBtn.setAttribute('aria-selected', 'true');
        tableBtn.classList.remove('active'); tableBtn.setAttribute('aria-selected', 'false');
      } else {
        cardView.style.display = 'none';
        tableView.style.display = 'block';
        cardBtn.classList.remove('active'); cardBtn.setAttribute('aria-selected', 'false');
        tableBtn.classList.add('active'); tableBtn.setAttribute('aria-selected', 'true');
      }
    }

    function escapeHTML(s) {
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
    function escapeAttr(s) { return escapeHTML(s); }

    document.getElementById('searchInput').addEventListener('input', filterResources);
    document.getElementById('typeFilter').addEventListener('change', filterResources);
    document.getElementById('statusFilter').addEventListener('change', filterResources);

    document.addEventListener('DOMContentLoaded', () => {
      loadResources(); // site reads data.json at runtime
      setView('table');
    });
  </script>
</body>
</html>
